function doGet() {
  return HtmlService.createHtmlOutputFromFile('index')
      .setTitle('科技庫存管理系統 2.0')
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

// 取得物品清單 (假設在 '庫存表' 的 A 欄)
function getItems() {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('庫存表'); 
  // 若沒有庫存表，請自行修改或是建立一個
  if (!sheet) return [];
  var lastRow = sheet.getLastRow();
  if (lastRow < 2) return [];
  var data = sheet.getRange(2, 1, lastRow - 1, 1).getValues();
  return data.flat().filter(String);
}

// 處理表單提交
function processForm(formObject) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('紀錄');
  if (!sheet) {
    sheet = SpreadsheetApp.getActiveSpreadsheet().insertSheet('紀錄');
    sheet.appendRow(['系統時間', '發生日期', '動作', '物品', '人員', '數量']); // 建立標頭
  }
  
  // 取得表單數據
  var actionDate = formObject.actionDate; // 使用者選的日期
  var item = formObject.item;
  var action = formObject.actionType;
  var name = formObject.userName;
  var qty = formObject.quantity;
  var timestamp = new Date(); // 系統自動記錄的時間

  // 寫入資料
  sheet.appendRow([timestamp, actionDate, action, item, name, qty]);
  
  return "成功：已記錄 " + name + " " + action + " " + item;
}

// 搜尋歷史紀錄功能
function searchHistory(keyword) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('紀錄');
  if (!sheet) return [];
  
  var data = sheet.getDataRange().getValues();
  var result = [];
  
  // 從第 2 行開始跑 (跳過標題)
  // 假設欄位順序: 0:系統時間, 1:發生日期, 2:動作, 3:物品, 4:人員, 5:數量
  for (var i = 1; i < data.length; i++) {
    var row = data[i];
    var rowName = String(row[4]).toLowerCase(); // 人員名稱在第 5 欄 (索引4)
    var searchKey = String(keyword).toLowerCase();
    
    // 如果名字包含搜尋關鍵字
    if (rowName.indexOf(searchKey) > -1) {
      // 格式化日期以便閱讀
      var displayDate = row[1];
      if (displayDate instanceof Date) {
        displayDate = Utilities.formatDate(displayDate, Session.getScriptTimeZone(), "yyyy-MM-dd");
      }
      
      result.push({
        date: displayDate,
        action: row[2],
        item: row[3],
        name: row[4],
        qty: row[5]
      });
    }
  }
  
  // 反轉陣列，讓最新的顯示在最上面
  return result.reverse();
}
