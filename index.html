<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å°é›»ææ–™ç®¡ç†ç³»çµ±</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=Orbitron:wght@600;900&display=swap" rel="stylesheet" />
  <style>
    :root {
      --ukiyo-deep-blue: #1D3B56;
      --ukiyo-mid-blue: #2A587A;
      --ukiyo-light-blue: #6B93B8;
      --ukiyo-foam: #F0F4F5;
      --ukiyo-sky: #E6D3A3;
      --ukiyo-paper: #F2E6D9;
      --glass-bg: rgba(255, 255, 255, 0.85);
      --glass-border: rgba(255, 255, 255, 0.9);
      --danger-red: #d64545;
    }
    body {
      font-family: 'Noto Sans TC', sans-serif;
      margin: 0;
      padding: 0;
      color: #1a202c;
      overflow-x: hidden;
      background-color: var(--ukiyo-sky);
      min-height: 100vh;
      position: relative;
    }

    /* èƒŒæ™¯å‹•ç•« */
    .ukiyo-scene {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      overflow: hidden;
      background: radial-gradient(circle at 50% 30%, #f7f0e6, var(--ukiyo-sky));
    }
    .mt-fuji {
      position: absolute;
      bottom: 25%;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 150px solid transparent;
      border-right: 150px solid transparent;
      border-bottom: 200px solid #2c3e50;
      z-index: 1;
    }
    .mt-fuji::after {
      content: '';
      position: absolute;
      top: 60px;
      left: -150px;
      width: 300px;
      height: 140px;
      background: linear-gradient(to bottom, #fff 20%, transparent 80%);
      clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
      transform: scale(0.28) translateY(-320px);
    }
    .wave { position: absolute; bottom: 0; width: 200%; height: 100%; background-repeat: repeat-x; background-position: bottom; transform: translate3d(0, 0, 0); }
    .wave-back { z-index: 2; height: 45%; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 800 180' preserveAspectRatio='none'%3E%3Cpath d='M0,120 C150,150 250,80 400,110 C550,140 650,80 800,110 L800,180 L0,180 Z' fill='%232A587A' opacity='0.8'/%3E%3C/svg%3E"); animation: moveWave 25s linear infinite; }
    .wave-mid { z-index: 3; height: 40%; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 800 180' preserveAspectRatio='none'%3E%3Cpath d='M0,100 C200,60 350,140 600,80 C750,40 800,100 800,100 L800,180 L0,180 Z' fill='%236B93B8' opacity='0.9'/%3E%3C/svg%3E"); animation: moveWave 15s linear infinite reverse; }
    .wave-front { z-index: 4; height: 35%; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320' preserveAspectRatio='none'%3E%3Cpath fill='%231D3B56' fill-opacity='1' d='M0,160L48,176C96,192,192,224,288,224C384,224,480,192,576,165.3C672,139,768,117,864,128C960,139,1056,181,1152,197.3C1248,213,1344,203,1392,197.3L1440,192L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E"); animation: moveWave 10s linear infinite; }
    @keyframes moveWave { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }

    /* UI å…§å®¹ */
    .content-wrapper { position: relative; z-index: 10; padding: 0 16px 80px; }
    header { position: sticky; top: 15px; z-index: 100; max-width: 900px; margin: 20px auto; background: var(--ukiyo-deep-blue); color: white; border-radius: 12px; padding: 15px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(29, 59, 86, 0.5); border: 2px solid #D4AF37; }
    .container-3d { background: var(--glass-bg); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); max-width: 950px; margin: 30px auto; border-radius: 20px; padding: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); border: 1px solid var(--glass-border); }
    h3.section-title { color: var(--ukiyo-deep-blue); border-left: 6px solid var(--danger-red); padding-left: 15px; margin: 25px 0 15px; font-weight: 900; }
    input, select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; font-size: 1rem; box-sizing: border-box; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
    .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1.2fr; gap: 15px; margin-bottom: 15px; }
    .material-btn { padding: 12px; background: white; border: 1px solid #ddd; cursor: pointer; border-radius: 8px; text-align: center; transition: 0.2s; font-weight: 600; color: var(--ukiyo-deep-blue); }
    .material-btn.active { background: var(--ukiyo-mid-blue); color: white; }
    .btn-save { width: 100%; padding: 18px; border: none; border-radius: 12px; background: linear-gradient(45deg, var(--ukiyo-deep-blue), var(--ukiyo-mid-blue)); color: white; font-size: 1.2rem; font-weight: 900; cursor: pointer; transition: 0.3s; margin-top: 15px; }
    .btn-save:hover { background: var(--danger-red); transform: translateY(-2px); }

    /* æœå°‹èˆ‡æ­·å²ç´€éŒ„ */
    .search-box { background: rgba(29, 59, 86, 0.08); padding: 20px; border-radius: 15px; margin-bottom: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    #logList { display: none; margin-top: 20px; } /* é è¨­éš±è—æ¸…å–® */
    .record-li { background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; border-left: 5px solid var(--ukiyo-mid-blue); box-shadow: 0 4px 6px rgba(0,0,0,0.05); position: relative; }
    .btn-delete { background: none; border: none; color: #ccc; cursor: pointer; font-size: 1.2rem; transition: 0.2s; }
    .btn-delete:hover { color: var(--danger-red); }
    .btn-clear-all { grid-column: span 2; padding: 10px; background: none; border: 1px dashed var(--danger-red); color: var(--danger-red); border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 5px; }
    .btn-clear-all:hover { background: var(--danger-red); color: white; }
    .analysis-box { background: #fff; padding: 15px; border-radius: 10px; margin-top: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.04); }

    /* small helpers */
    .warn { color: var(--danger-red); font-weight:700; }
    .ok { color: green; font-weight:700; }

    /* æµ®ä¸–ç¹ªé¢¨æ ¼è£½ä½œäººç°½å - å·¦ä¸‹è§’ */
    .ukiyo-signature {
      position: fixed;
      left: 18px;
      bottom: 18px;
      z-index: 220;
      font-weight: 900;
      font-size: 0.95rem;
      padding: 10px 14px;
      border-radius: 8px;
      background: linear-gradient(135deg, rgba(242,230,217,0.95), rgba(230,211,163,0.95));
      border: 2px solid rgba(29,59,86,0.12);
      transform: rotate(-6deg);
      box-shadow: 0 8px 20px rgba(29,59,86,0.15);
      color: #1D3B56;
      text-shadow: 0 1px 0 rgba(255,255,255,0.6);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-family: 'Noto Sans TC', sans-serif;
      backdrop-filter: blur(3px);
    }
    .ukiyo-signature::after{
      content: "æŸ¯";
      display:inline-block;
      width:28px;
      height:28px;
      line-height:28px;
      text-align:center;
      font-weight:900;
      color:#fff;
      background: var(--danger-red);
      border-radius:4px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
      transform: translateY(-1px);
      font-family: 'Orbitron', sans-serif;
    }

    @media (max-width: 768px) {
      .form-row, .form-row-3, .search-box { grid-template-columns: 1fr; }
      .btn-clear-all { grid-column: span 1; }
      .ukiyo-signature { left: 10px; bottom: 10px; font-size: 0.85rem; transform: rotate(-4deg); }
    }
  </style>
</head>
<body>
  <div class="ukiyo-scene">
    <div class="mt-fuji"></div>
    <div class="wave wave-back"></div>
    <div class="wave wave-mid"></div>
    <div class="wave wave-front"></div>
  </div>

  <div class="content-wrapper">
    <header>
      <div style="font-weight:900; font-size: 1.4rem; letter-spacing: 2px;">å°é›»ææ–™ç®¡ç†ç³»çµ±</div>
    </header>

    <div class="container-3d">
      <form id="materialForm">
        <h3 class="section-title">å£¹ã€æ—¥æœŸèˆ‡é¡å‹</h3>
        <div class="form-row">
          <div><label>ç•°å‹•æ—¥æœŸ</label><input type="date" id="mainDate" required /></div>
          <div><label>å€Ÿç”¨æ—¥æœŸ (ç„¡é ˜æ–™å–®å¡«å¯«)</label><input type="date" id="borrowDate" /></div>
        </div>

        <div class="form-row">
          <div>
            <label>ä½œæ¥­é¡å‹</label>
            <select id="transType">
              <option value="é ˜æ–™">é ˜æ–™ (Take)</option>
              <option value="å€Ÿç”¨">å€Ÿç”¨ (Borrow)</option>
              <option value="é€€æ–™">é€€æ–™ (Return)</option>
            </select>
          </div>
          <div><label>å–®è™Ÿ</label><input type="text" id="orderNo" placeholder="è«‹è¼¸å…¥å–®è™Ÿ (å¿…å¡«)" required /></div>
        </div>

        <h3 class="section-title">è²³ã€äººå“¡èˆ‡ææ–™</h3>
        <div class="form-row">
          <input type="text" id="personName" placeholder="é ˜/é€€/å€Ÿç”¨äººå§“å (å¿…å¡«)" required />
          <input type="text" id="staffName" placeholder="ç™¼/æ”¶æ–™ç¶“è¾¦äºº (å¿…å¡«)" required />
        </div>

        <div style="margin-top:10px">
          <label>æ–™è™Ÿ (Part No.)ï¼ˆé¸å¡«ï¼‰</label>
          <!-- æ”¹ç‚ºé¸å¡«ï¼ˆç§»é™¤ requiredï¼‰ -->
          <input type="text" id="partNo" placeholder="è«‹è¼¸å…¥æ–™è™Ÿï¼ˆé¸å¡«ï¼Œç¯„ä¾‹ï¼šT68-0001ï¼‰" />
        </div>

        <select id="category" onchange="renderMaterials()" style="margin-top:10px">
          <option value="">-- é¸æ“‡ææ–™é¡åˆ¥ï¼ˆé¸å¡«ï¼‰ --</option>
          <option value="A">A é¡ (ç¤™å­)</option>
          <option value="B">B é¡ (éµä»¶)</option>
          <option value="C">C é¡ (ç·šæ)</option>
          <option value="F">F é¡ (è®Šå£“å™¨)</option>
          <option value="H">H é¡ (é–‹é—œ)</option>
        </select>

        <div id="materialsContainer" style="margin-top:15px; display:grid; grid-template-columns:1fr 1fr; gap:10px"></div>

        <div id="qtySection" style="display:block; margin-top:20px;">
          <div class="form-row-3">
            <input type="number" id="qty" placeholder="æ•¸é‡ (å¿…å¡«)" min="1" required />
            <input type="text" id="unit" placeholder="å–®ä½ (PC/KG..)" required />
            <select id="evalType">
              <option value="">-- è©•åƒ¹é¡å‹ --</option>
              <option value="0æ–°">(0æ–°)</option>
              <option value="1èˆŠ">(1èˆŠ)</option>
              <option value="3(è³‡ç”¢æ–°)">3(è³‡ç”¢æ–°)</option>
              <option value="4(è³‡ç”¢èˆŠ)">4(è³‡ç”¢èˆŠ)</option>
            </select>
          </div>
          <button type="submit" class="btn-save">ğŸŒŠ ç¢ºèªå„²å­˜ç´€éŒ„</button>
        </div>
      </form>
    </div>

    <div class="container-3d" style="background: rgba(255, 255, 255, 0.75);">
      <h2 style="color:var(--ukiyo-deep-blue); text-align:center; margin-top:0">ğŸ“‹ æ­·å²ç´€éŒ„æŸ¥è©¢</h2>
      <div class="search-box">
        <input type="text" id="searchPerson" placeholder="ğŸ” æœå°‹å§“å..." onkeyup="handleSearch()">
        <input type="text" id="searchStaff" placeholder="ğŸ” æœå°‹ç¶“è¾¦äºº..." onkeyup="handleSearch()">
        <input type="text" id="searchPartNo" placeholder="ğŸ” æœå°‹æ–™è™Ÿ..." onkeyup="handleSearch()">
        <select id="searchYear" onchange="handleSearch()">
          <option value="">æ‰€æœ‰å¹´ä»½</option>
          <option value="2024">2024å¹´</option>
          <option value="2025">2025å¹´</option>
          <option value="2026">2026å¹´</option>
        </select>
        <select id="searchMonth" onchange="handleSearch()">
          <option value="">æ‰€æœ‰æœˆä»½</option>
        </select>
        <button class="btn-clear-all" onclick="clearAllRecords()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ­·å²ç´€éŒ„</button>
      </div>

      <div id="logList"></div>

      <!-- æ–°å¢å¿«é€Ÿæ–™è™ŸåŠŸèƒ½å€ -->
      <div style="margin-top:18px; display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
        <div class="analysis-box">
          <h4>ğŸ” å³æ™‚åº«å­˜æŸ¥è©¢</h4>
          <input type="text" id="queryPartNo" placeholder="è¼¸å…¥æ–™è™ŸæŸ¥è©¢åº«å­˜ (ä¾‹ï¼šT68-0001)">
          <div style="display:flex; gap:8px; margin-top:8px;">
            <button class="material-btn" onclick="queryInventory()">æŸ¥è©¢åº«å­˜</button>
            <button class="material-btn" onclick="openBaselineDialog()">è¨­å®š/èª¿æ•´åˆå§‹åº«å­˜</button>
          </div>
          <div id="inventoryResult" style="margin-top:10px;"></div>
        </div>

        <div class="analysis-box">
          <h4>ğŸ“Š å­˜è²¨åˆ†æèˆ‡é æ¸¬</h4>
          <input type="text" id="analysisPartNo" placeholder="è¼¸å…¥æ–™è™Ÿé€²è¡Œæ­·å²èˆ‡é æ¸¬åˆ†æ">
          <div style="display:flex; gap:8px; margin-top:8px;">
            <button class="material-btn" onclick="analyzePart()">ç”¢ç”Ÿåˆ†æå ±å‘Š</button>
            <button class="material-btn" onclick="openThresholdDialog()">è¨­å®šé è­¦</button>
          </div>
          <div id="analysisResult" style="margin-top:10px;"></div>
        </div>
      </div>

      <!-- baseline & threshold dialogs (ç°¡æ˜“ UI) -->
      <div id="dialogs" style="margin-top:12px"></div>
    </div>
  </div>

  <!-- æµ®ä¸–ç¹ªé¢¨æ ¼è£½ä½œäººç°½åï¼ˆå·¦ä¸‹ï¼‰ -->
  <div class="ukiyo-signature">è£½ä½œäººï¼šæŸ¯æ–‡å±•</div>

  <script>
    /* ======= è³‡æ–™çµæ§‹èˆ‡åˆå§‹è³‡æ–™ ======= */
    const materialDict = {
      "A": ["èšåˆæŸ±å‹ç¤™å­ 11.4kV", "æ‡¸å‚ç¤™å­ Cå‹ 15000ç£… Ï†10' ç°è‰²", "æ‡¸å‚ç¤™å­ Cå‹ 10000ç£… 6'Ï† ç°è‰²", "é˜²ç›¬è£è…³ç¤™å­ 11.4KV ç„¡è…³", "è»¸å‹ç¤™å­ ä½å£“ è»¸å‹", "æ‹‰ç·šç¤™å­ ä½å£“ å¤§å‹ L139.7ãœ", "èšåˆæŸ±å‹ç¤™å­ 22.8KV", "èšåˆè£è…³ç¤™å­ 11.4KV å¤¾ç·šå‹"],
        "B": ["äº’é€£å™¨ é–“æ¥å‹A / 477MCM XLPE", "äº’é€£å™¨ é–“æ¥å‹B / AWG #2 XLPE", "äº’é€£ç¹© Bå‹/ 112ã", "äº’é€£ç¹© Aå‹ / 52ã", "äº’é€£å™¨ å¤¾æ¢å‹A / 477MCM XLPE", "äº’é€£å™¨ å¤¾æ¢å‹B / AWG #2 XLPE", "é…é›»ç·šè·¯é›»æ¡¿åå…‰è²¼ç´™ ééå±¤ç«‹æ–¹è§’éŒä¹‹å¾®ç¨œé¡åå°„ææ–™ 90x100ã é»ƒé»‘ç›¸é–“è‰²", "é…é›»ç·šè·¯é›»æ¡¿åå…‰è²¼ç´™ ééå±¤ç«‹æ–¹è§’éŒä¹‹å¾®ç¨œé¡åå°„ææ–™ 90x60ã é»ƒé»‘ç›¸é–“è‰²", "æ‹‰ç·šå¤¾æ¿ éŠ…ç·š 100-150ãœÂ²", "æ‹‰ç·šå¤¾æ¿ é‹ç·š AWG 2/0-#2", "æ‹‰ç·šå¤¾æ¿ é‹ç·š 477MCM-300MCM-AWG 4/0", "Vå‹æ›éµ Aå‹ç„¡ç¸« SS400", "æ´»ç·šç·šå¤¾ éŠ…ç·š M8-60ãœ2,T8-50ãœ2", "Hå‹å£“æ¥å¥—ç®¡ é‹è£½ A#2,C60-38Ã—A#2-#6,C38-14", "ç¢³é‹¼æ“´å¼µèºæ “ S45C Hå…§ç‰™å¤–è¿«å¼ 5/8'Ï†x2-1/2'", "é›»åŠ›ä¿éšªçµ²çµ„æ¶ˆéŸ³å™¨ 25KV 200A", "é‰»é…¸é‹…ç³Š 1ç£…è£ æè¦Y413", "é™æµç†”çµ² 15.5kV 40A 25kA é™„æŠ‘å¼§é–‹é—œ", "é›»åŠ›ä¿éšªçµ² 25kV 65E 12.5kA", "é›»åŠ›ä¿éšªçµ² 25kV 125E 12.5kA", "é–‹é—œç®± å±‹å¤–å‹ ä¸é½é‹¼ 600x400x230ãœ T2ãœ", "å£“æ¥å¥—ç®¡ éŠ… 22ãœÂ² éŠ…è£½", "å£“æ¥å¥—ç®¡ éŠ… 60ãœÂ² éŠ…è£½", "å£“æ¥å¥—ç®¡ éŠ… 100ãœ2 éŠ…è£½", "Cå‹å£“æ¥å¥—ç®¡ éŠ…è£½ éŠ…14-22Ã—8 Î±å‹", "Cå‹å£“æ¥å¥—ç®¡ éŠ…è£½ éŠ…14-38Ã—14-38 Î²å‹", "é›»æ¡¿ç¶å¸¶ è¤‡åˆé›»æ¡¿ç”¨Bå‹ Ï†235Ã—75Ã—6ãœ", "é…é›»ç·šè·¯é›»æ¡¿åå…‰æ¨™èªç‰‡ CNS 4345æ„Ÿå£“å‹ç¬¬1ç´š 33x12ãè‡ªé»å¼Y193", "é›»æ¡¿ç‰Œ é‹ 220Ã—90Ã—T0.511ãœ è—åº•ç™½å­—", "è·¯ç‡ˆé–‹é—œ 1P 240Vac 135A éæ°´éŠ€å¼", "è·¯ç‡ˆé–‹é—œ 1P 240Vac 135A é›»ç£å¼", "æˆå‹æ”¯ç·šå¤¾æ¢ GSW 55ãœ2 è¥¯åœˆå‹ L890ãœ", "è§’å‹æ©«æ“”æŠ¼ L1420ãœ", "è§’å‹æ©«æ“”æŠ¼ L1745ãœ", "é ‚æ¢¢ 11kV é˜²ç›¬è£è…³ç¤™å­ SS400", "ä½å£“ç·šæ¶ ä¸‰ç·šå¼ éé‹…é‹¼ é™„éµé–‚", "ä½å£“ç·šæ¶ äº”ç·šå¼ éé‹…é‹¼ é™„éµé–‚", "éµé–‚ å–®çœ¼ Ï†5/8'Ã—1800ãœ éµéé‹…", "ç«‹é›•å‹ç·šè·¯æŒ‡ç¤ºå™¨ å–®ç›¸ 15kV æŒ‡ç¤ºç‡ˆå‹", "æ”¯æ¶ #1é›»çºœå›ºå®šå¸¶ç”¨ Lå‹ 135Ã—92.5Ã—72Ã—T3ãœ 304SST", "æ”¯æ¶ 500MCMé›»çºœå›ºå®šå¸¶ç”¨ Lå‹140x92.5x87xT3ãœ 304SST", "å£“æ¥ç«¯å­ éŠ… 250MCM é–‰å£å‹ çŸ­å‹ 2å­” 13ãœÏ†", "å£“æ¥ç«¯å­ éŠ… 500MCM é–‰å£å‹ é•·å‹ 2å­” 15ãœÏ† å±‹å¤–çµ‚ç«¯ç”¨", "èºæ “é– é–é‰¤:5ãœÏ† é–é‰¤:é‹ èºæ “:SS400 æ “æ¶µ:é‚é‹çŸ½åˆé‡‘", "å­”è“‹å®šä½æ¨™ç¤ºå™¨ 66.3KHz æ¸¬æ·±50ã", "å­”è“‹å®šä½æ¨™ç¤ºå™¨ 169.8KHz æ¸¬æ·±50ã", "ä¼¸å‡ºéµæ¶ æ¨™æº–å¼ éé‹…é‹¼", "è¢«è¦†ç“·ç½© é™¶ç“· 11.4KVæ¡¿ä¸Šè®Šå£“å™¨ç”¨ 90Ï†x95Ï†xH95ãœ", "éé‹…æ–¹å¢Šåœˆ SS400 M16 18ãœÏ†x4.5ãœ L52xW52ãœ", "éé‹…æ–¹é ­èºæ “ SGD30 M16Ã—P2.0Ã—240ãœ é™„å–®èºå¸½", "éé‹…æ–¹é ­èºæ “ SGD30 M16Ã—P2.0Ã—300ãœ é™„å–®èºå¸½", "ä½å£“ç·šæ¶ å–®ç·šå¼ éé‹…é‹¼ é™„éµé–‚", "æ‹‰ç·šå¤¾æ¿ éŠ…ç·š 22-38ãœÂ²", "æ©«æ“”æ¢¢ 11kV é˜²ç›¬è£è…³ç¤™å­ SS400", "éé‹…æ–¹é ­èºæ “ SGD290-D M16Ã—P2.0Ã—270ãœ é™„å–®èºå¸½", "éé‹…æ–¹é ­èºæ “ SGD30 M16Ã—P2.0Ã—350ãœ é™„å–®èºå¸½", "éé‹…æ–¹é ­èºæ “ SGD290-D M16Ã—P2.0Ã—450ãœ é™„å–®èºå¸½", "æ£‰ç´—æ‰‹å¥— æ£‰ç´—å«æ£‰é‡100ï¼… L250ãœ é›»å·¥ç”¨", "æ‹‰ç·šå¤¾æ¿ éŠ…ç·š 50-80ãœ2", "éé‹…æ–¹é ­èºæ “ SGD30 M16Ã—P2.0Ã—140ãœ é™„å–®èºå¸½", "éé‹…æ–¹é ­èºæ “ SGD30 M16Ã—P2.0Ã—210ãœ é™„å–®èºå¸½"],
        "C": ["25KVäº¤é€£PEå¼•æ¥ç·š 1C éŠ… 22ãœ2 äº¤é€£PEè¢«è¦† è¢«è¦†é¡è‰²é»‘è‰²", "600V PVCé‹é¢¨é›¨ç·š 1C é‹ AWG #2 è—è‰²", "600V PVCé‹é¢¨é›¨ç·š 1C é‹ AWG #2 ç°è‰²", "600V PVCé¢¨é›¨ç·š 1C éŠ… 8ãœ2 é»‘è‰²", "600V PVCé¢¨é›¨ç·š 1C éŠ… 22ãœ2 é»‘è‰²", "600V PVCé‹é¢¨é›¨ç·š 1C é‹ AWG 4/0 è—è‰²", "é‹¼å¿ƒé‹ç·š AWG #2 6/1", "å…¨é‹ç·š 300MCM 19è‚¡", "ç¡¬éŠ…çµç·š(ä¸€èˆ¬ç”¨) 100ãœÂ²", "600V PVCé›»ç·š 1C éŠ… 60ãœ2 é»‘è‰²", "600V PVCé›»ç·š 1C éŠ… 22ãœ2 é»‘è‰²", "600V PVCé›»ç·š 1C éŠ… 8ãœ2 é»‘è‰²", "ç¡¬éŠ…çµç·š(ä¸€èˆ¬ç”¨) 60ãœÂ²", "ç¡¬éŠ…çµç·š(ä¸€èˆ¬ç”¨) 22ãœÂ²", "ç´ ææœ¨æ©«æ“” L1800Ã—90Ã—90ãœ", "ç´ ææœ¨æ©«æ“” L1200Ã—90Ã—90ãœ", "600V PVCé¢¨é›¨ç·š 1C éŠ… 60ãœ2 é»‘è‰²", "600V PVCé¢¨é›¨ç·š 1C éŠ… 125ãœ2 é»‘è‰²", "éé‹…é‹¼çµç·š 55ãœÂ² (Ï†3.2ãœÃ—7è‚¡) æ”¯ç·šç”¨ Sæ’š", "éé‹…éµç·š SWM BWG#8 (Ï†4.19ãœ)", "è¼•é‹¼æ©«æ“” L2400Ã—75Ã—75Ã—T2.3ãœ", "éé‹…ç­‰é‚Šè§’é‹¼ SS400 90Ã—90Ã—T10ãœ", "ç®¡è·¯å°å¡ RP-03å‹ 80ãœÏ† ä¸€èˆ¬ç”¨", "ç®¡è·¯å°å¡ RP-05å‹ 125ãœÏ† ä¸€èˆ¬ç”¨", "ç®¡è·¯å°å¡ RP-06å‹ 150ãœÏ† ä¸€èˆ¬ç”¨", "é›»çºœç”¨çµ•ç·£è† è†å¸¶ T3.175ãœxW38.1ãœxL152ã", "è‡ªèæ€§é˜²æ°´è† å¸¶ T1.7ãœxW38ãœxL305ã", "é å¼µå¼é›»çºœçµ‚ç«¯æ¥é ­ å±‹å¤–å‹ 25kV 1C éŠ… 500MCM", "é å¼µå¼é›»çºœçµ‚ç«¯æ¥é ­ å±‹å¤–å‹ 25kV 1C éŠ… AWG #1", "å¥—ç®¡æ’é ­ 25kV 200A AWG #1", "é é‘„å‹é›»çºœç›´ç·šæ¥é ­ 25kV 1C éŠ… AWG #1", "é é‘„å‹é›»çºœç›´ç·šæ¥é ­ 25kV 1C éŠ… 500MCM", "æ’é ­å°å¥— 25kV 200A AWG #1", "è² è¼‰å¯åˆ‡è‚˜å‹ç«¯é ­ 25kV 200A AWG #1 æœ‰é›»å£“æ¸¬è©¦é»", "å››è·¯åˆ†æ­§æ’é ­ 25kV 200A AWG #1", "è² è¼‰ä¸å¯åˆ‡è‚˜å‹ç«¯é ­ 25kV 600A 500MCM æœ‰é›»å£“æ¸¬è©¦é»", "å››è·¯åˆ†æ­§æ’é ­ 25kV 200A AWG #1 Aé¡é…é›»ç®±ç”¨", "é›™é€šå¥—ç®¡æ’é ­ 25kV 200A AWG #1", "é›™é€šæ’é ­ 25kV 200A AWG #1", "çŒè† å¼é›»çºœåˆ†æ­§æ¥é ­ 600V 1C éŠ… AWG 2/0~250MCM", "æ¥æˆ¶æ©«æœ¨ 60Ã—60ãœ"],
        "F": ["äº­ç½®å¼é–‹é—œ 3ç›¸ 24kV å››è·¯ 2-600A 2-200A SF6çµ•ç·£ä½ç¢³é‹¼å‹", "éæ™¶è³ªéµå¿ƒæ¡¿ä¸Šè®Šå£“å™¨ å–®ç›¸ 6.9kV 240/120V 25kVA", "æ”¹è‰¯å¥—ç®¡å‹æ¡¿ä¸Šè®Šå£“å™¨ å–®ç›¸ 6.9kV 240/120V 50kVA", "éæ™¶è³ªéµå¿ƒæ¡¿ä¸Šè®Šå£“å™¨ å–®ç›¸ 6.9kV 240/120V 50kVA", "éæ™¶è³ªéµå¿ƒæ¡¿ä¸Šè®Šå£“å™¨ å–®ç›¸ 6.9kV 240/120V 100kVA", "å¯†å°å‹æ¡¿ä¸Šè®Šå£“å™¨ å–®ç›¸ 6.9kV 240/120V 100kVA ä¸é½é‹¼", "å¯†å°å‹æ¡¿ä¸Šè®Šå£“å™¨ å–®ç›¸ 6.9kV 240/120V 50kVA ä¸é½é‹¼", "æ¡¿ä¸Šè®Šå£“å™¨ å–®ç›¸ 6.9kV 240/120V 50kVA", "æ¡¿ä¸Šè®Šå£“å™¨ å–®ç›¸ 6.9kV 240/120V 25kVA", "å¯†å°å‹æ¡¿ä¸Šè®Šå£“å™¨ å–®ç›¸ 6.9kV 240/120V 25kVA ä¸é½é‹¼", "é›»å®¹å™¨ç”¨æ²¹é–‹é—œ å–®ç›¸ 14.4kV 200A æ‰‹å‹•/é›»å‹• 115Vac", "é«˜å£“é›»å®¹å™¨ å–®ç›¸ 6.9kV 200kVAR å±‹å¤–å‹", "é«˜å£“é›»å®¹å™¨ å–®ç›¸ 6.9kV 100kVAR å±‹å¤–å‹", "æ”¹è‰¯å¥—ç®¡å‹æ¡¿ä¸Šè®Šå£“å™¨ å–®ç›¸ 6.9kV 240/120V 167kVA", "æ¡¿ä¸Šè®Šå£“å™¨ å–®ç›¸ 6.9/13.8kV 240/120V 25kVA ä¸éŠ¹é‹¼", "æ¡¿ä¸Šè®Šå£“å™¨ å–®ç›¸ 6.9kV 240/120V 100kVA ä¸é½é‹¼", "æ¡¿ä¸Šè®Šå£“å™¨ å–®ç›¸ 6.9/13.8kV 240/120V 100kVA ä¸éŠ¹é‹¼", "äº­ç½®å¼è®Šå£“å™¨ å–®ç›¸ 6.9/13.8kV 25kVA ç›´å¼é«˜ç‡ƒé»ä¸€èˆ¬å‹é™„åˆ†æ¥é ­", "äº­ç½®å¼è®Šå£“å™¨ å–®ç›¸ 6.9/13.8kV 50kVA ç›´å¼é«˜ç‡ƒé»ä¸€èˆ¬å‹é™„åˆ†æ¥é ­", "æ”¹è‰¯å¥—ç®¡å‹æ¡¿ä¸Šè®Šå£“å™¨ å–®ç›¸ 6.9kV 240/120V 100kVA", "äº­ç½®å¼è®Šå£“å™¨ å–®ç›¸ 6.9/13.8kV 167kVAç›´å¼é«˜ç‡ƒé»ä¸€èˆ¬å‹é™„åˆ†æ¥é ­", "äº­ç½®å¼è®Šå£“å™¨ å–®ç›¸ 6.9/13.8kV 167kVAç›´å¼é«˜ç‡ƒé»ä¸€èˆ¬å‹é™„åˆ†æ¥é ­", "äº­ç½®å¼æ°£å°é–‹é—œ ä¸‰ç›¸ 24kV å››è·¯ 3-600A 1-200A SF6çµ•ç·£", "äº­ç½®å¼é–‹é—œ 3ç›¸ 24kV äºŒè·¯ 2-200A SF6çµ•ç·£ ä½ç¢³é‹¼å‹", "åœ°ä¸‹å››è·¯è‡ªå‹•ç·šè·¯é–‹é—œ ä¸‰ç›¸ 24kV 600A 2S2F 24Vç°¡æ˜“å‹(Ié‡æ¸¬)", "äº­ç½®å¼æ°£å°é–‹é—œ ä¸‰ç›¸ 24kV å››è·¯ 2-600A 2-200A SF6çµ•ç·£", "åœ°ä¸‹å››è·¯è‡ªå‹•ç·šè·¯é–‹é—œ ä¸‰ç›¸24kV600A 3S1F 24Væ¨™æº–å‹(Vã€Ié‡æ¸¬)", "é«˜å£“é…é›»ç®± å±‹å¤–å‹ éµ Aé¡x1 å–®å…·çµ„", "äº­ç½®å¼è®Šå£“å™¨ å–®ç›¸ 6.9/13.8kV 25kVA ç›´å¼é™„åˆ†æ¥é ­", "äº­ç½®å¼è®Šå£“å™¨ å–®ç›¸ 6.9/13.8kV 100kVAç›´å¼é«˜ç‡ƒé»ä¸€èˆ¬å‹é™„åˆ†æ¥é ­", "äº­ç½®å¼è®Šå£“å™¨ å–®ç›¸ 6.9/13.8kV 100kVAç›´å¼é«˜ç‡ƒé»ä¸€èˆ¬å‹é™„åˆ†æ¥é ­", "äº­ç½®å¼è®Šå£“å™¨ ä¸‰ç›¸ 12/24kV 500kVA é«˜ç‡ƒé»ä¸€èˆ¬å‹é™„åˆ†æ¥é ­", "é«˜å£“é…é›»ç®± å±‹å¤–å‹ ä¸é½é‹¼ Aé¡x1 å–®å…·çµ„", "é«˜å£“é…é›»ç®± å±‹å¤–å‹ ä¸é½é‹¼ Aé¡x1 å–®å…·çµ„", "é åŠ›æ··å‡åœŸåŸºæ¨ é åŠ›é›»æ¡¿ç”¨ 4000x200x40ãœ", "é«˜å£“é…é›»ç®± å±‹å¤–å‹ ä¸é½é‹¼ Bé¡Jå‹", "é«˜å£“é…é›»ç®± å±‹å¤–å‹ ä¸é½é‹¼ Bé¡På‹", "é«˜å£“é…é›»ç®± å±‹å¤–å‹ ä¸é½é‹¼ Dé¡x1 å–®å…·çµ„", "é åŠ›é›»æ¡¿ 9m é…é›» åœ“å‹ Bç´š", "é åŠ›é›»æ¡¿ 10.5m é…é›» åœ“å‹ Bç´š", "é åŠ›æ··å‡åœŸåŸºæ¨ 6000x250x50ãœ", "é åŠ›æ··å‡åœŸåŸºæ¨ 6000x250x50ãœ", "äººå­”è“‹(å«å¤–è“‹åŠè“‹åº§)MC-150å‹å¤–è“‹Ï†908Ã—80ãœè“‹åº§Ï†1200Ã—150ãœ", "æ°´æ³¥è…³æœ¨ ç©ºå¿ƒåœ“å½¢G3 Ï†150Ã—1000ãœ æ”¯ç·šç”¨", "é åŠ›é›»æ¡¿ 14m é…é›» åœ“å‹ Cç´š", "é åŠ›é›»æ¡¿ 12m é…é›» åœ“å‹ Cç´š", "é åŠ›é›»æ¡¿ 12m é…é›» åœ“å‹ Eç´š", "æ‰‹å­”è“‹HR150å¤–è“‹1068Ã—668Ã—80ãœåº§1210Ã—810Ã—150ãœ", "æ‰‹å­”è“‹å¢Šåº§ æ–¹å‹ 1210x810x200ãœ æ··å‡åœŸ"],
        "H": ["é›»åŠ›ä¿éšªçµ²åº§ 25KV 200A ç«¯å­å¼", "é›»åŠ›ä¿éšªçµ²åº§ 25KV 200A å¥—ç®¡å¼", "é™æµç†”çµ²åº§ 15.5KV 200A å¥—ç®¡å¼", "é™æµç†”çµ²åº§ 15.5KV 200A ç«¯å­å¼", "ç·šè·¯æ•…éšœæŒ‡ç¤ºå™¨ å–®ç›¸ 280A(600A) 1a 2æŒ‡ç¤ºç‡ˆ é›»æ± ", "ç·šè·¯æ•…éšœæŒ‡ç¤ºå™¨ å–®ç›¸ 800A(1000A) 1a 2æŒ‡ç¤ºç‡ˆ é›»æ± ", "ç·šè·¯æ•…éšœæŒ‡ç¤ºå™¨ å–®ç›¸ 800A 1æŒ‡ç¤ºç‡ˆ é›»æ±  FIC OV-A æ¶ç©ºç·šè·¯", "èšåˆå‹ç†”çµ²éˆé–‹é—œ 15/27kV 100A 12kA å±‹å¤–å‹ é™„è¢«è¦†ç½©", "é…é›»ç´šç“·å¥—ç®¡é¿é›·å™¨ 9KV 10KA æ°§åŒ–é‹… ç„¡é›·æ“Šè¨ˆæ•¸å™¨ é˜²é¹½å‹", "é…é›»ç´šç“·å¥—ç®¡é¿é›·å™¨ 9kV 10kA æ°§åŒ–é‹… ç„¡é›·æ“Šè¨ˆæ•¸å™¨ ä¸€èˆ¬å‹", "é…é›»ç´šèšåˆå¥—ç®¡é¿é›·å™¨ 18KV 10KA æ°§åŒ–é‹… ç„¡é›·æ“Šè¨ˆæ•¸å™¨", "é«˜å£“è¢«è¦†ç½© PE 11.4kV #2 Hå£“æ¥å‹æ¥ç·šç’°ç”¨", "é«˜å£“è¢«è¦†ç½© PE 11.4kV #2 æ‹‰ç·šå¤¾æ¿ç”¨(åœ“å½¢é–‹å£)", "é«˜å£“è¢«è¦†ç½© PE 11.4kV 477MCM Hå£“æ¥å‹æ¥ç·šç’°ç”¨", "é«˜å£“è¢«è¦†ç½© PE 22.8kV 477Cåœ“å½¢é–‹å£ 477MCMå°ç·šã€æ‹‰ç·šå¤¾æ¿ç”¨", "é«˜å£“è¢«è¦†ç½© PE 22.8kV 477H 477MCMå°ç·šã€Hå£“æ¥å‹æ¥ç·šç’°ç”¨", "é«˜å£“è¢«è¦†ç½© PE 22.8kV #2åœ“å½¢é–‹å£ #2AWGå°ç·šã€æ‹‰ç·šå¤¾æ¿ç”¨", "é«˜å£“è¢«è¦†ç½© PE 22.8kV #2H #2AWGç·šã€Hå£“æ¥å‹æ¥ç·šç’°ç”¨", "è¢«è¦†ç½© çŸ½æ©¡è†  11.4/22.8kV é¿é›·å™¨ç”¨", "æ‰‹å‹•å‹ç·šè·¯è² è¼‰å•Ÿæ–·é–‹é—œ ä¸‰ç›¸ 15kV 600A å±‹å¤–å‹ SF6", "æ¶ç©ºè‡ªå‹•ç·šè·¯é–‹é—œ ä¸‰ç›¸ 25.8kV 600A 24Vdc æ¨™æº–å‹é–‚é–å‹ç„¡æ§åˆ¶ç®±", "è² è¼‰å•Ÿæ–·é–‹é—œ ä¸‰ç›¸ 25.8kV 600A å±‹å¤–å‹ SF6 æ‰‹å‹•å‹", "ç†”çµ²éˆé–‹é—œ 7.8/15kV 100A 10kA å±‹å¤–å‹ ä¸é½é‹¼å›ºå®šæ¶é™„è¢«è¦†ç½©å‹", "é…é›»ç´šèšåˆå¥—ç®¡é¿é›·å™¨ 9KV 10KA æ°§åŒ–é‹… ç„¡é›·æ“Šè¨ˆæ•¸å™¨", "Uå‹è»‹é ­ UC-501", "ç¢³é‹¼å–®çœ¼èºå¸½ SGD290-D M16-N/A", "æ¶ç©ºè‡ªå‹•ç·šè·¯é–‹é—œ ä¸‰ç›¸ 15kV 600A 24Vdc æ¨™æº–å‹é–‚é–å‹ç„¡æ§åˆ¶ç®±", "æ¥åœ°éŠ…æ£’ Ï†5/8Ã—L8' é™„ç·šå¤¾", "ç†”çµ²éˆé–‹é—œ 7.8/15kV 100A 10kA å±‹å¤–å‹ é–‹å‹"]
    };

    // records æ ¼å¼èˆ‡ localStorage éµ
    // records æ¯ç­†ç‰©ä»¶çµæ§‹:
    // { id, date, type, person, staff, item, partNo, qty, unit, evalType, orderNo }
    let records = JSON.parse(localStorage.getItem("ukiyo_db_v5") || "[]");
    let baselineStocks = JSON.parse(localStorage.getItem("ukiyo_baseline_v1") || "{}");
    let thresholds = JSON.parse(localStorage.getItem("ukiyo_thresholds_v1") || "{}");
    let selectedItem = "";

    function renderMaterials() {
      const cat = document.getElementById("category").value;
      const box = document.getElementById("materialsContainer");
      box.innerHTML = "";
      if (!cat) return;
      (materialDict[cat] || []).forEach(m => {
        const d = document.createElement("div");
        d.className = "material-btn";
        d.innerText = m;
        d.onclick = () => {
          selectedItem = m;
          document.getElementById("qtySection").style.display = "block";
          Array.from(box.children).forEach(c => c.classList.remove("active"));
          d.classList.add("active");
        };
        box.appendChild(d);
      });
    }

    /* å„²å­˜é‚è¼¯ï¼ˆå«æ–™è™Ÿèˆ‡å–®è™Ÿï¼‰ */
    document.getElementById("materialForm").onsubmit = function (e) {
      e.preventDefault();
      const qtyVal = Number(document.getElementById("qty").value || 0);
      if (!qtyVal || qtyVal <= 0) {
        alert("è«‹è¼¸å…¥æ­£ç¢ºæ•¸é‡");
        return;
      }
      // partNo å·²æ”¹ç‚ºé¸å¡«ï¼šå…è¨±ç©ºå­—ä¸²
      const partNo = (document.getElementById("partNo").value || "").trim();
      const orderNo = (document.getElementById("orderNo").value || "").trim();
      if (!orderNo) {
        alert("è«‹è¼¸å…¥å–®è™Ÿ");
        return;
      }
      const data = {
        id: Date.now(),
        date: document.getElementById("mainDate").value,
        type: document.getElementById("transType").value,
        person: document.getElementById("personName").value,
        staff: document.getElementById("staffName").value,
        item: selectedItem || "",
        partNo: partNo,
        qty: qtyVal,
        unit: document.getElementById("unit").value,
        evalType: document.getElementById("evalType").value,
        orderNo: orderNo
      };
      records.unshift(data);
      localStorage.setItem("ukiyo_db_v5", JSON.stringify(records));
      alert("âœ… ç´€éŒ„å·²æˆåŠŸå„²å­˜ï¼");
      // é‡ç½®éƒ¨åˆ†è¡¨å–®
      document.getElementById("qty").value = "";
      document.getElementById("orderNo").value = "";
      handleSearch();
    };

    /* æœå°‹èˆ‡é¡¯ç¤ºæ­·å² */
    function handleSearch() {
      const sPerson = document.getElementById("searchPerson").value.trim();
      const sStaff = document.getElementById("searchStaff").value.trim();
      const sYear = document.getElementById("searchYear").value;
      const sMonth = document.getElementById("searchMonth").value;
      const sPart = document.getElementById("searchPartNo").value.trim();
      const list = document.getElementById("logList");
      // å¦‚æœæ‰€æœ‰æœå°‹æ¢ä»¶éƒ½æ˜¯ç©ºçš„ï¼Œå‰‡éš±è—æ¸…å–®
      if (!sPerson && !sStaff && !sYear && !sMonth && !sPart) {
        list.style.display = "none";
        return;
      }
      list.style.display = "block";
      renderHistory(sPerson, sStaff, sYear, sMonth, sPart);
    }

    function renderHistory(sPerson, sStaff, sYear, sMonth, sPart) {
      const list = document.getElementById("logList");
      list.innerHTML = "";
      const filtered = records.filter(r => {
        let rYear = "", rMonth = "";
        if (r.date) {
          const parts = r.date.split("-");
          rYear = parts[0] || "";
          rMonth = parts[1] || "";
        }
        return (sPerson === "" || (r.person && r.person.includes(sPerson)))
          && (sStaff === "" || (r.staff && r.staff.includes(sStaff)))
          && (sPart === "" || (r.partNo && r.partNo.includes(sPart)))
          && (sYear === "" || rYear === sYear)
          && (sMonth === "" || rMonth === sMonth);
      });

      if (filtered.length === 0) {
        list.innerHTML = "<p style='text-align:center; color:#999;'>æŸ¥ç„¡ç›¸ç¬¦ç´€éŒ„</p>";
        return;
      }

      filtered.forEach(r => {
        const div = document.createElement("div");
        div.className = "record-li";
        div.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:flex-start;">
            <div>
              <b>${r.date || ''}</b>
              <span style="color:var(--danger-red); border:1px solid var(--danger-red); padding:1px 6px; font-size:0.8em; border-radius:4px; margin-left:5px">${r.type}</span><br>
              <span style="color:var(--ukiyo-mid-blue); font-weight:bold; font-size:1.05em; display:block; margin-top:5px">${r.item || 'æœªå¡«åç¨±'}</span>
              <div style="margin-top:6px; font-size:0.9em;">æ–™è™Ÿ: <b>${r.partNo || 'æœªå¡«'}</b> ï½œ å–®è™Ÿ: <b>${r.orderNo || 'æœªå¡«'}</b></div>
            </div>
            <div style="text-align:right">
              <button class="btn-delete" onclick="deleteRecord(${r.id})">ğŸ—‘ï¸</button>
            </div>
          </div>
          <div style="margin-top:10px; font-size:0.9em; border-top:1px dashed #eee; padding-top:8px; display:grid; grid-template-columns: 1fr 1fr;">
            <span>æ•¸é‡: <b>${r.qty}</b> ${r.unit || ''}</span>
            <span style="text-align:right">è¦æ ¼: <small>${r.evalType || 'æœªå¡«'}</small></span>
            <span>ğŸ‘¤ ${r.person || ''}</span>
            <span style="text-align:right">ğŸ–Šï¸ ç¶“è¾¦: ${r.staff || ''}</span>
          </div>
        `;
        list.appendChild(div);
      });
    }

    /* åˆªé™¤å–®ç­† */
    function deleteRecord(id) {
      if (confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚")) {
        records = records.filter(r => r.id !== id);
        localStorage.setItem("ukiyo_db_v5", JSON.stringify(records));
        handleSearch();
      }
    }

    /* å…¨éƒ¨åˆªé™¤ */
    function clearAllRecords() {
      if (confirm("âš ï¸ æ³¨æ„ï¼šé€™å°‡æœƒæ°¸ä¹…åˆªé™¤æ­¤è£ç½®ä¸Šæ‰€æœ‰çš„æ­·å²ç´€éŒ„ï¼\næ‚¨ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ")) {
        const finalCheck = confirm("å†æ¬¡ç¢ºèªï¼šçœŸçš„è¦å…¨éƒ¨åˆªé™¤å—ï¼Ÿ");
        if (finalCheck) {
          records = [];
          localStorage.setItem("ukiyo_db_v5", JSON.stringify(records));
          alert("å·²æ¸…é™¤æ‰€æœ‰ç´€éŒ„ã€‚");
          handleSearch();
        }
      }
    }

    /* åˆå§‹è¨­å®šæ—¥æœŸ */
    document.getElementById("mainDate").valueAsDate = new Date();

    /* ======= å³æ™‚åº«å­˜èˆ‡åˆ†æ ======= */
    function computeInventory(partNo) {
      const baseline = Number(baselineStocks[partNo] || 0);
      let inv = baseline;
      const relevant = records.filter(r => r.partNo === partNo).sort((a, b) => new Date(a.date) - new Date(b.date));
      relevant.forEach(r => {
        if (r.type === 'é ˜æ–™' || r.type === 'å€Ÿç”¨') inv -= Number(r.qty);
        else if (r.type === 'é€€æ–™') inv += Number(r.qty);
      });
      const usageByYear = {};
      relevant.forEach(r => {
        const yr = (r.date || '').split("-")[0] || 'unknown';
        const qty = Number(r.qty) || 0;
        if (!usageByYear[yr]) usageByYear[yr] = 0;
        if (r.type === 'é ˜æ–™' || r.type === 'å€Ÿç”¨') usageByYear[yr] += qty;
        else if (r.type === 'é€€æ–™') usageByYear[yr] -= qty;
      });
      return { inventory: inv, baseline, lastRecords: relevant.slice().reverse(), usageByYear };
    }

    function queryInventory() {
      const part = document.getElementById("queryPartNo").value.trim();
      const out = document.getElementById("inventoryResult");
      out.innerHTML = "";
      if (!part) {
        out.innerHTML = "<div style='color:#999'>è«‹è¼¸å…¥æ–™è™Ÿ</div>";
        return;
      }
      const res = computeInventory(part);
      const inv = res.inventory;
      let html = `
        <div>æ–™è™Ÿ: <b>${part}</b><br>åˆå§‹/ç›¤é»åº«å­˜: <b>${res.baseline}</b><br>ç›®å‰åº«å­˜ (ä¾ç´€éŒ„è¨ˆç®—): <b>${inv}</b></div>
      `;
      const th = thresholds[part];
      if (th) {
        html += `<div style="margin-top:8px;">`;
        if (th.safetyStock != null) {
          html += `å®‰å…¨åº«å­˜: <b>${th.safetyStock}</b>ã€‚`;
          if (inv < th.safetyStock && th.lowAlert) html += `<div class="warn">âš ï¸ åº«å­˜ä½æ–¼å®‰å…¨åº«å­˜ï¼ (å·²å•Ÿç”¨ä½æ–¼å®‰å…¨åº«å­˜æé†’)</div>`;
          if (inv > th.safetyStock && th.highAlert) html += `<div class="warn">âš ï¸ åº«å­˜é«˜æ–¼å®‰å…¨åº«å­˜ (å·²å•Ÿç”¨é«˜æ–¼å®‰å…¨åº«å­˜æé†’)</div>`;
          if (inv >= th.safetyStock && !th.highAlert) html += `<div class="ok">åº«å­˜>=å®‰å…¨åº«å­˜</div>`;
          if (inv < th.safetyStock && !th.lowAlert) html += `<div class="warn">åº«å­˜ä½æ–¼å®‰å…¨å€¼ (ä½†æé†’åŠŸèƒ½æœªå•Ÿç”¨)</div>`;
        }
        const usageYears = Object.values(res.usageByYear).map(v => Number(v));
        const annualUsage = usageYears.reduce((a, b) => a + b, 0) / (usageYears.length || 1);
        const avgInventory = (Math.max(res.baseline, 0) + inv) / 2;
        const turnover = avgInventory > 0 ? (annualUsage / avgInventory) : null;
        if (turnover != null) {
          html += `<div style="margin-top:6px">ä¼°è¨ˆå¹´ä½¿ç”¨é‡: ${annualUsage.toFixed(2)}ï¼Œä¼°è¨ˆå­˜è²¨å‘¨è½‰ç‡: ${turnover.toFixed(2)}</div>`;
          if (th.turnoverThreshold && turnover > th.turnoverThreshold) {
            html += `<div class="warn">âš ï¸ å‘¨è½‰ç‡é«˜æ–¼è¨­å®šé–¾å€¼ (${th.turnoverThreshold})ï¼Œå¯èƒ½éœ€æ±‚æ¿€å¢æˆ–åº«å­˜åä½ã€‚</div>`;
          }
        }
        html += `</div>`;
      } else {
        html += `<div style="margin-top:8px; color:#666">å°šç„¡è¨­å®šå®‰å…¨åº«å­˜/è­¦ç¤ºã€‚å¯æŒ‰ã€Œè¨­å®šé è­¦ã€ç‚ºæ­¤æ–™è™Ÿé–‹å•Ÿæé†’ã€‚</div>`;
      }

      if (res.lastRecords.length) {
        html += `<div style="margin-top:10px;"><b>æœ€è¿‘ç´€éŒ„ (æœ€æ–°åœ¨å‰)</b><ul>`;
        res.lastRecords.slice(0, 8).forEach(r => {
          html += `<li>${r.date || ''} ${r.type || ''} ${r.qty || ''}${r.unit || ''} å–®è™Ÿ:${r.orderNo || ''} ç¶“è¾¦:${r.staff || ''}</li>`;
        });
        html += `</ul></div>`;
      }
      out.innerHTML = html;
    }

    /* ======= baseline è¨­å®šä»‹é¢ ======= */
    function openBaselineDialog() {
      const dialogs = document.getElementById("dialogs");
      dialogs.innerHTML = `
        <div class="analysis-box">
          <h4>ğŸ¯ è¨­å®š / èª¿æ•´ åˆå§‹åº«å­˜ (ç›¤é»)</h4>
          <input type="text" id="basePartNo" placeholder="æ–™è™Ÿ">
          <input type="number" id="baseQty" placeholder="åº«å­˜æ•¸é‡" min="0">
          <div style="display:flex; gap:8px; margin-top:8px;">
            <button class="material-btn" onclick="saveBaseline()">å„²å­˜ç›¤é»</button>
            <button class="material-btn" onclick="closeDialogs()">å–æ¶ˆ</button>
          </div>
          <div id="baseMsg" style="margin-top:8px;"></div>
        </div>
      `;
    }

    function saveBaseline() {
      const p = (document.getElementById("basePartNo").value || "").trim();
      const q = Number(document.getElementById("baseQty").value || 0);
      const msg = document.getElementById("baseMsg");
      if (!p) { msg.innerHTML = "<div style='color:#d64545;'>è«‹è¼¸å…¥æ–™è™Ÿ</div>"; return; }
      if (q < 0) { msg.innerHTML = "<div style='color:#d64545;'>åº«å­˜æ•¸é‡éœ€ >= 0</div>"; return; }
      baselineStocks[p] = q;
      localStorage.setItem("ukiyo_baseline_v1", JSON.stringify(baselineStocks));
      msg.innerHTML = "<div style='color:green'>å·²å„²å­˜ç›¤é»åˆå§‹åº«å­˜ã€‚</div>";
      setTimeout(() => { closeDialogs(); }, 800);
    }

    /* ======= é–¾å€¼/é è­¦è¨­å®šä»‹é¢ ======= */
    function openThresholdDialog(partNoCandidate) {
      const dialogs = document.getElementById("dialogs");
      const candidate = partNoCandidate || document.getElementById("analysisPartNo").value.trim() || document.getElementById("queryPartNo").value.trim() || '';
      dialogs.innerHTML = `
        <div class="analysis-box">
          <h4>ğŸš¨ è¨­å®šé è­¦ (æ–™è™Ÿ)</h4>
          <input type="text" id="thPartNo" placeholder="æ–™è™Ÿ" value="${candidate}">
          <input type="number" id="thSafety" placeholder="å®‰å…¨åº«å­˜æ•¸é‡" min="0">
          <div style="margin-top:8px; display:grid; grid-template-columns:1fr 1fr; gap:8px;">
            <label><input type="checkbox" id="thLowAlert"> ä½æ–¼å®‰å…¨åº«å­˜æé†’ (ä½æ–¼å³è­¦ç¤º)</label>
            <label><input type="checkbox" id="thHighAlert"> é«˜æ–¼å®‰å…¨åº«å­˜æé†’ (é«˜æ–¼å³è­¦ç¤º)</label>
          </div>
          <input type="number" id="thTurnover" placeholder="å‘¨è½‰ç‡è­¦ç¤ºé–¾å€¼ (å¯ç•™ç©º)" min="0" step="0.1">
          <div style="display:flex; gap:8px; margin-top:8px;">
            <button class="material-btn" onclick="saveThreshold()">å­˜æª”</button>
            <button class="material-btn" onclick="closeDialogs()">å–æ¶ˆ</button>
          </div>
          <div id="thMsg" style="margin-top:8px;"></div>
        </div>
      `;
    }

    function saveThreshold() {
      const p = (document.getElementById("thPartNo").value || "").trim();
      if (!p) { document.getElementById("thMsg").innerHTML = "<div style='color:#d64545'>è«‹è¼¸å…¥æ–™è™Ÿ</div>"; return; }
      const safety = Number(document.getElementById("thSafety").value || 0);
      const lowAlert = document.getElementById("thLowAlert").checked;
      const highAlert = document.getElementById("thHighAlert").checked;
      const turnover = (document.getElementById("thTurnover").value !== "") ? Number(document.getElementById("thTurnover").value) : null;
      thresholds[p] = { safetyStock: safety, lowAlert, highAlert, turnoverThreshold: turnover };
      localStorage.setItem("ukiyo_thresholds_v1", JSON.stringify(thresholds));
      document.getElementById("thMsg").innerHTML = "<div style='color:green'>å·²å„²å­˜é è­¦è¨­å®šã€‚</div>";
      setTimeout(() => { closeDialogs(); }, 800);
    }

    function closeDialogs() {
      document.getElementById("dialogs").innerHTML = "";
    }

    /* ======= å­˜è²¨åˆ†æï¼ˆæ­·å²çµ±è¨ˆèˆ‡æœªä¾†é æ¸¬ï¼‰ ======= */
    function analyzePart() {
      const part = (document.getElementById("analysisPartNo").value || "").trim();
      const out = document.getElementById("analysisResult");
      out.innerHTML = "";
      if (!part) { out.innerHTML = "<div style='color:#999'>è«‹è¼¸å…¥æ–™è™Ÿ</div>"; return; }

      const today = new Date();
      const maxYears = 10;
      const earliestYear = today.getFullYear() - (maxYears - 1);
      const relevant = records.filter(r => r.partNo === part && r.date && Number(r.date.split("-")[0]) >= earliestYear);

      if (relevant.length === 0) { out.innerHTML = `<div style='color:#999'>æŸ¥ç„¡æ­¤æ–™è™Ÿéå» ${maxYears} å¹´å…§ç´€éŒ„</div>`; return; }

      const usageByYear = {}; // å¹´åº¦æ·¨ç”¨é‡
      const usageByMonthYear = {}; // 'YYYY-MM' => netUsage

      relevant.forEach(r => {
        const [yr, mo] = (r.date || "").split("-");
        const keyMY = `${yr}-${mo}`;
        const qty = Number(r.qty) || 0;
        const delta = (r.type === 'é ˜æ–™' || r.type === 'å€Ÿç”¨') ? qty : (r.type === 'é€€æ–™' ? -qty : 0);
        usageByYear[yr] = (usageByYear[yr] || 0) + delta;
        usageByMonthYear[keyMY] = (usageByMonthYear[keyMY] || 0) + delta;
      });

      const years = Object.keys(usageByYear).sort();
      const yearValues = years.map(y => usageByYear[y]);
      const yearCount = years.length;
      const yearSum = yearValues.reduce((a, b) => a + b, 0);
      const yearAvg = yearCount ? yearSum / yearCount : 0;

      const monthSums = {};
      const monthCounts = {};
      Object.keys(usageByMonthYear).forEach(k => {
        const [yr, mo] = k.split("-");
        monthSums[mo] = (monthSums[mo] || 0) + usageByMonthYear[k];
        monthCounts[mo] = (monthCounts[mo] || 0) + 1;
      });
      const monthAverages = {};
      for (let m = 1; m <= 12; m++) {
        const mm = m.toString().padStart(2, '0');
        monthAverages[mm] = monthCounts[mm] ? (monthSums[mm] / monthCounts[mm]) : 0;
      }

      // ç°¡å–®ç·šæ€§å›æ­¸ (å¹´ vs usage)
      let slope = 0, intercept = yearAvg;
      if (yearCount >= 2) {
        const xs = years.map((y, i) => i);
        const ys = yearValues;
        const xMean = xs.reduce((a, b) => a + b, 0) / xs.length;
        const yMean = ys.reduce((a, b) => a + b, 0) / ys.length;
        let num = 0, den = 0;
        for (let i = 0; i < xs.length; i++) {
          num += (xs[i] - xMean) * (ys[i] - yMean);
          den += (xs[i] - xMean) * (xs[i] - xMean);
        }
        slope = den === 0 ? 0 : num / den;
        intercept = yMean - slope * xMean;
      }

      const predictions = [];
      const lastYear = Math.max(...years.map(y => Number(y)));
      for (let m = 1; m <= 12; m++) {
        const xNext = years.length;
        const predictedYearTotal = intercept + slope * xNext;
        const mm = m.toString().padStart(2, '0');
        const seasonDenom = Object.values(monthAverages).reduce((a, b) => a + Math.abs(b), 0) || 12;
        const fraction = Math.abs(monthAverages[mm]) / seasonDenom;
        const predictedMonth = predictedYearTotal * fraction;
        const fallback = yearAvg / 12;
        const finalPred = (monthAverages[mm] === 0) ? fallback : predictedMonth;
        const nextYearLabel = lastYear + 1;
        predictions.push({ month: `${nextYearLabel}-${mm}`, predicted: finalPred });
      }

      let html = `<div><b>æ–™è™Ÿ ${part} çš„åˆ†æ (æœ€è¿‘æœ€å¤š ${maxYears} å¹´ç¯„åœ)</b></div>`;
      html += `<div style="margin-top:8px">è³‡æ–™å¹´ä»½ç¯„åœ: ${years[0]} - ${years[years.length - 1]} (å…± ${yearCount} å¹´)</div>`;
      html += `<div style="margin-top:8px">å¹´åº¦æ·¨ç”¨é‡å¹³å‡ (å¹´å¹³å‡): <b>${yearAvg.toFixed(2)}</b></div>`;
      html += `<div style="margin-top:10px"><b>æ¯æœˆåŒæœˆå¹³å‡ (åå¹´å…§åŒæœˆå¹³å‡)</b><table style="width:100%; border-collapse:collapse; margin-top:6px;">`;
      html += `<tr style="background:#f4f6f8;"><th style="padding:6px;">æœˆä»½</th><th style="padding:6px;">å¹³å‡ç”¨é‡</th></tr>`;
      for (let m = 1; m <= 12; m++) {
        const mm = m.toString().padStart(2, '0');
        html += `<tr><td style="padding:6px;">${m}æœˆ</td><td style="padding:6px;">${monthAverages[mm].toFixed(2)}</td></tr>`;
      }
      html += `</table></div>`;

      html += `<div style="margin-top:10px"><b>ç°¡æ˜“é æ¸¬ (æœªä¾† 12 å€‹æœˆéœ€æ±‚ä¼°è¨ˆ)</b><ol>`;
      predictions.forEach(p => { html += `<li>${p.month}: ${p.predicted.toFixed(2)}</li>`; });
      html += `</ol></div>`;

      html += `<div style="margin-top:10px"><b>é€å¹´æ·¨ç”¨é‡</b><ul>`;
      years.forEach(y => html += `<li>${y}: ${usageByYear[y].toFixed(2)}</li>`);
      html += `</ul></div>`;

      const invInfo = computeInventory(part);
      html += `<div style="margin-top:8px"><b>å³æ™‚åº«å­˜åƒè€ƒï¼š</b> åˆå§‹: ${invInfo.baseline}, ç›®å‰: ${invInfo.inventory}</div>`;
      const th = thresholds[part];
      if (th) {
        if (invInfo.inventory < th.safetyStock && th.lowAlert) html += `<div class="warn">âš ï¸ åº«å­˜ä½æ–¼å®‰å…¨åº«å­˜ (å·²å•Ÿç”¨ä½æ–¼æé†’)</div>`;
        if (invInfo.inventory > th.safetyStock && th.highAlert) html += `<div class="warn">âš ï¸ åº«å­˜é«˜æ–¼å®‰å…¨åº«å­˜ (å·²å•Ÿç”¨é«˜æ–¼æé†’)</div>`;
      }

      out.innerHTML = html;
    }

    /* å·¥å…·ï¼šè¼‰å…¥ localStorageï¼ˆdebug / initï¼‰ */
    function loadAllFromStorage() {
      records = JSON.parse(localStorage.getItem("ukiyo_db_v5") || "[]");
      baselineStocks = JSON.parse(localStorage.getItem("ukiyo_baseline_v1") || "{}");
      thresholds = JSON.parse(localStorage.getItem("ukiyo_thresholds_v1") || "{}");
    }
    loadAllFromStorage();

    /* åˆå§‹åŒ–æœˆä»½ä¸‹æ‹‰ï¼ˆé¿å… document.write èªæ³•éŒ¯èª¤ï¼‰*/
    (function initMonths() {
      const sel = document.getElementById("searchMonth");
      for (let i = 1; i <= 12; i++) {
        const opt = document.createElement("option");
        opt.value = i.toString().padStart(2, '0');
        opt.textContent = `${i}æœˆ`;
        sel.appendChild(opt);
      }
    })();
  </script>
</body>
</html>
